<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link type="text/css" href="styles.css" rel="stylesheet" />
    <link type="text/css" href="simpletextextractor.css" rel="stylesheet" />
    <!-- <link rel="stylesheet" type="text/css"
    href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css"> -->
    <link href="dist/sp-bootstrap.min.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" type="text/css"
    href="//cdn.datatables.net/plug-ins/1.10.7/integration/bootstrap/3/dataTables.bootstrap.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="shortcut icon" href="images/favicon.png">
    <title>OracleX</title>
    <!-- Custom styles for this template -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
  <body >
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html">
            <!-- <span class="navbar-logo">Spotify</span> -->
            <span class="navbar-title">OracleX</span>
            <span class="navbar-title">Music to Flow</span>
          </a>
        </div>
        <!-- <div class="navbar-collapse collapse">
          <a href="http://www.spotify.com" class="btn btn-primary navbar-btn navbar-right">Get
          Spotify</a>
        </div><!--/.navbar-collapse --> -->
      </div>
    </div>

    <!-- Main jumbotron for a primary marketing message or call to action -->
      <div id='intro'>
      <div id='main' class="top worker jumbotron jumbotron-hero container-fluid" style="margin-top: 65px;">
          <div  id="jumbo-dialog">
            <h1 id='ttitle' >Understand <span class="rotate">Your Music.,Your State., You.</span></h1>
            <h3 id='ttitle' >“Without Music, life would be a mistake” - Friedrich Nietzsche</span></h1>
            <p id='ttext'>
                Explore your playlists to understand how and why it affects your state. Change attributes such as the tempo, energy and danceability.
            </p>
            <!-- <p>  Login with your Spotify account to get started</p> -->
            <p><a class="btn btn-primary btn-lg" id='go' role="button">Login with Spotify</a></p>
          </div>
      </div>

        <div class="container worker ">
          <div class="row features">
             <div class="col-md-offset-2 col-md-8">
                    <h2 class="text-center">
                      <span class="rotate">Relaxed, Upbeat, Focussed</span> on demand?</h2>
                    <p>
                    With <b> OracleX </b> Order the songs in any of your playlists by a wide range of parameters
                     such as putting the beats per minute between 140-180 to get you upbeat and ready for exercise! Just
                    follow these steps:
                    </p>
                    <ol>
                        <li> <b> Login </b> with your Spotify credentials
                        <li> <b> Pick </b> your playlist
                        <li> <b> Sort </b> the playlist by clicking on the column headings in
                        the playlist table
                        <li>  <b> Save </b> the sorted playlist to Spotify
                        <li>Tap into the power of <b>Music</b>
                    </ol>

                    <h2 class="text-center">Harness the power of Music</h2>
                    <p>
                    The attributes of your songs will help you to understand why the playlist is making you “feel” that way…
                    So you can get to that feeling or state gain, <b> quicker </b> .
                    </p>

                    <ol>
                        <li> <b> Beats Per Minute (BPM)</b> - The tempo of the
                        song.
                        <li> <b> Energy</b> - The energy of a song - the higher
                        the value, the more energtic.
                        song
                        <li> <b> Danceability</b> - The higher the value, the
                        easier it is to dance to this song.
                        <li> <b> Loudness </b> - The higher the value, the
                        louder the song.
                        <li> <b> Valence </b> - The higher the value, the
                        more positive mood for the song.
                        <li> <b> Length </b> - The duration of the song.
                        <li> <b> Acoustic </b> - The higher the value the more
                        acoustic the song is.
                        <li> <b> Popularity </b> - The higher the value the more
                        popular the song is.
                    </ol>
              </div>
          </div>
        </div>

        <!-- Overlay for fixed sidebar -->
        <div class="sidebar-overlay"></div>

        <!-- Material sidebar -->
        <aside id="sidebar" class="sidebar sidebar-default sidebar-stacked" role="navigation" style="margin-top: 80px;">
            <!-- Sidebar header -->
            <div class="sidebar-header header-cover" style="background-image: url(http://www.uidownload.com/files/390/350/393/dark-blue-music-background-vector-thumb.jpg);">
                <!-- Top bar -->
                <div class="top-bar"></div>
                <!-- Sidebar toggle button -->
                <button type="button" class="sidebar-toggle">
                    <i class="icon-material-sidebar-arrow"></i>
                </button>

                <div class="container">
                    <div id="result"></div>
                </div>

                <script id="result-template" type="text/x-handlebars-template">
                  <div class="row">
                    <div class="sidebar-image">
                      <img class="avatar" alt="avatar" style="width: 60px;" src="{{images.0.url}}">
                    </div>
                    <div >
                      <p data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown" style="text-align: left;margin: 10px;">Hi, <a href="{{external_urls.spotify}}" target="_blank">{{display_name}}</a>
                      <b class="caret"></b></p>
                    </div>
                  </div>
                </script>

                <!-- Sidebar brand image -->
                <!-- <div class="sidebar-image">
                    <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/53474/atom_profile_01.jpg">
                </div> -->
                <!-- Sidebar brand name -->
                <!-- <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
                    john.doe@gmail.com
                    <b class="caret"></b>
                </a> -->
            </div>

            <!-- Sidebar navigation -->
            <ul class="nav sidebar-nav">
                <li class="dropdown">
                    <ul id="settings-dropdown" class="dropdown-menu">
                        <li>
                            <a href="#" tabindex="-1">
                                Profile
                            </a>
                        </li>
                        <li>
                            <a href="#" tabindex="-1">
                                Settings
                            </a>
                        </li>
                        <li>
                            <a href="#" tabindex="-1">
                                Help
                            </a>
                        </li>
                        <li>
                            <a href="#" tabindex="-1">
                                Exit
                            </a>
                        </li>
                    </ul>
                </li>
                <div class="sidebar-text">Your Playlists</div>
                <div class="container worker" id='playlists'>
                      <!-- <h2 class="prompt" > We've loaded all your Spotify playlists. Choose one to find out more about yourself: </h2> -->
                      <img class='spinner' width='100' alt='spinner' src='images/ajaxSpinner.gif'>

                      <div class="panel panel-default" style="width: 460px;">
                          <table id='playlist-list' class="table">
                              <thead>
                                  <tr>
                                  <!-- <th>Name</th> -->
                                  <!-- <th>Track Count</th>
                                  <th>Owner</th> -->
                                  </tr>
                              </thead>
                              <tbody> </tbody>
                          </table>
                      </div>
                </div>

        </aside>

        <div class="wrapper">
            <!-- Sidebar Constructor -->
            <div class="constructor">
              <p><button class="btn btn-primary btn-sm sidebar-toggle" style="margin-top: 100px;margin-bottom: 10px;">Hide Playlists</button></p>
              <div class="top jumbotron container-fluid">

                <p id='info' class="text-center"></p>

                <div class="container worker" id='single-playlist'>
                      <h2> <a id='playlist-title'></a> </h2>
                      <img class='spinner2' width='100' alt='spinner' src='images/ajaxSpinner.gif'>
                      <div id='single-playlist-contents'>

                          <div class="row">
                            <div class="col-md-6">
                              <h2>Playlist Profile</h2>
                              <p>Each one of these songs in this playlist is represented by a color. The overall shape illustrates the sound profile of this playlist.</p>
                              <div class="radarChart2"></div>
                            </div>
                            <div class="col-md-6" >
                              <!-- <select onChange="updateHistogram(this.value);">
                                <option value="0">acousticness</option>
                                <option value="1">energy</option>
                                <option value="2">instrumentalness</option>
                                <option value="3">liveliness</option>
                                <option value="4">speechiness</option>
                                <option value="5">valence</option>
                              </select> -->
                              <h2 id="titlegraph"></h2>
                              <p id="descriptiongraph"></p>
                              <button id='curve_it' type='button' class='btn btn-primary btn-sm has-spinner'><i class="fa fa-spinner fa-spin"></i> Curve It!</button>
                              <div class="graph"></div>
                            </div>
                          </div>
                          <!-- <div class="container">
                            <div class="graph"></div>
                          </div> -->
                          <div class="panel panel-default">
                              <div class="panel-heading">Filter</div>
                              <div class="container" style="margin-top: 20px;">
                              <li>Click on a song to play it (1 click - some may not work)</p>
                              <li> Click on a heading to reorder by attribute (e.g  tempo, danceability)</p>
                              </div>
                              <div class="panel-body">
                                  <div class="form-inline">
                                    <!-- <a class="btn btn-primary btn-sm pull-left" id='pick'
                                        role="button">back</a> -->
                                      <div class="form-group" style="margin-left:30px">
                                          <label for="min-bpm">Minimum BPM</label>
                                          <input id="min-bpm" type="number" class="form-control" placeholder="0">
                                      </div>
                                      <div class="form-group">
                                          <label for="max-bpm">Maximum BPM</label>
                                          <input id="max-bpm" type="number" class="form-control" placeholder="1000">
                                      </div>
                                      <!-- <div class="form-group">
                                          <label for="include-double">Include Doubled BPM</label>
                                          <input id="include-double" type="checkbox" checked="checked">
                                      </div> -->
                                      <button id="filter-button" class="btn btn-default btn-sm">Filter</button>
                                      <div class='btn-group pull-right'>
                                        <button id='save' type='button' class='btn btn-primary btn-sm has-spinner'><i class="fa fa-spinner fa-spin"></i> Save New Playlist</button>
                                        <button id='saveDropdown' type='button' class='btn btn-primary btn-sm dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>
                                          <span class='caret'></span>
                                          <span class='sr-only'>Toggle Dropdown</span>
                                        </button>
                                        <ul class='dropdown-menu'>
                                          <li><a id='dropSave' href='#'>Save New Playlist</a></li>
                                          <li><a id='dropOverwrite' href='#'>Overwrite Playlist</a></li>
                                        </ul>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <table id='song-table' class="hover table table-condensed table-bordered table-striped">
                              <thead>
                                  <tr>
                                      <th> # </th>
                                      <th> Title </th>
                                      <th> Artist </th>
                                      <th> Release</th>
                                      <th> BPM </th>
                                      <th> Energy </th>
                                      <th> Dance </th>
                                      <th> Loud </th>
                                      <th> Valence </th>
                                      <th> Length </th>
                                      <th> Acoustic </th>
                                      <th> Pop. </th>
                                  </tr>
                              </thead>
                              <tbody> </tbody>
                              <tfoot> </tfoot>
                          </table>
                      </div>
                </div>
            </div>
            </div>
          </div>
    </div>

    <div id="footer">
      <div class="container text-center">
            <p class="text-muted">
                Powered by <a href="http://spotify.com">Spotify</a>.
            </p>
      </div>
    </div>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" charset="utf-8"
        src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf-8"
        src="//cdn.datatables.net/plug-ins/1.10.7/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>
    <!-- Deprecated: Replacement is the datetime plug-in (http://datatables.net/blog/2014-12-18) -->
    <script type="text/javascript" charset="utf-8"
        src="//cdn.datatables.net/plug-ins/1.10.7/sorting/time.js"></script>
    <script src="lib/bootstrap.min.js"></script>
    <script src="lib/underscore-min.js"></script>
    <script type="text/javascript" charset="utf-8"
        src="//cdnjs.cloudflare.com/ajax/libs/q.js/1.4.1/q.min.js"></script>
    <script src="config.js"></script>
    <script src="simplerotator.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
		<script src="https://d3js.org/d3-path.v1.min.js" charset="utf-8"></script>
    <script src="radarChart.js"></script>

<script>
"use strict";
var accessToken = null;
var curUserID = null;
var curPlaylist = null;
var albumDates = {};
var audio = $("<audio>");
var songTable;
var cols = [
    'order', 'title', 'artist', 'Date', 'BPM', 'energy',
    'danceability', 'loudness', 'valence', 'duration',
    'acousticness', 'popularity'
];
var values = [[],[],[],[],[],[],[],[],[],[],[]];
var dataset = {};
var CURVED = false;
// var values_indexes = {
//     BPM: 4,
//     energy: 5,
//     danceability:6,
//     loudness:7,
//     valence:8,
//     duration:9,
//     acousticness:10,
//     popularity:11,
//     instrumentalness:12,
//     liveness:13,
//     speechiness:14
// };
// console.log(values_indexes);

if(document.URL.indexOf('localhost') >=0){
  var SPOTIFY_REDIRECT_URI = 'http://localhost:8235/oraclex/';
}

// disable save while loading and saving, no matter what the saved state
var forceDisableSave = false;

// state of the saved playlist, so save button is only shown when different
var savedState = {};

function error(msg) {
    info(msg);
}

function getCurSortName() {
    var currentState = getPlaylistState();
    var prefix = (currentState.order[1] == 'asc') ? 'increasing ' : 'decreasing ';
    return prefix + cols[currentState.order[0]];
}

function info(msg) {
    $("#info").text(msg);
}

function authorizeUser() {
    var scopes = 'playlist-read-private playlist-modify-private playlist-modify-public';
    console.log("Spotify Client Id" + SPOTIFY_CLIENT_ID);
    console.log("Spotify Redirect URL" + SPOTIFY_REDIRECT_URI);
    var url = 'https://accounts.spotify.com/authorize?client_id=' + SPOTIFY_CLIENT_ID +
        '&response_type=token' +
        '&scope=' + encodeURIComponent(scopes) +
        '&redirect_uri=' + encodeURIComponent(SPOTIFY_REDIRECT_URI);
    document.location = url;
}

function parseArgs() {
    var hash = location.hash.replace(/#/g, '');
    var all = hash.split('&');
    var args = {};
    _.each(all, function(keyvalue) {
        var kv = keyvalue.split('=');
        var key = kv[0];
        var val = kv[1];
        args[key] = val;
    });
    return args;
}

function callSpotify(type, url, json, callback) {
    $.ajax(url, {
        type: type,
        data: JSON.stringify(json),
        dataType: 'json',
        headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
        },
        success: function(r) {
            callback(true, r);
        },
        error: function(r) {
            // 2XX status codes are good, but some have no
            // response data which triggers the error handler
            // convert it to goodness.
            if (r.status >= 200 && r.status < 300) {
                callback(true, r);
            } else {
                callback(false, r);
            }
        }
    });
}

function callSpotifyQ(type, url, json) {
    return Q.Promise(function(resolve, reject, notify) {
        $.ajax(url, {
            type: type,
            data: JSON.stringify(json),
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            },
            beforeSend : function () {
                console.log(type + ": " + this.url);
            },
            success: function(data) {
                resolve(data);
            },
            error: function(jqXHR, textStatus) {
                // 2XX status codes are good, but some have no
                // response data which triggers the error handler
                // convert it to goodness.
                if (jqXHR.status >= 200 && jqXHR.status < 300) {
                    resolve(undefined);
                } else {
                    reject(textStatus);
                }
            }
        });
    });
}

function getSpotify(url, data, callback) {
    $.ajax(url, {
        dataType: 'json',
        data: data,
        headers: {
            'Authorization': 'Bearer ' + accessToken
        },
        success: function(r) {
            callback(r);
        },
        error: function(r) {
            callback(null);
        }
    });
}

function getSpotifyQ(url, data) {
    return Q.Promise(function(resolve, reject, notify) {
        $.ajax(url, {
            dataType: 'json',
            data: data,
            headers: {
                'Authorization': 'Bearer ' + accessToken
            },
            beforeSend : function () {
                // console.log("GET: " + this.url);
            },
            success: function(data) {
                resolve(data);
            },
            error: function(jqXHR, textStatus) {
                if (jqXHR.status >= 200 && jqXHR.status < 300) {
                    resolve(undefined);
                } else {
                    reject(textStatus);
                }
            }
        });
    });
}

function showPlaylists() {
    $(".worker").hide();
    $("#playlists").show();
}

function fetchSinglePlaylist(playlist) {

    // $(".worker").hide();
    $("#single-playlist").show();
    $("#single-playlist-contents").hide();
    $(".spinner2").show();
    $("#song-table tbody").empty();
    window.scrollTo(0,0);
    disableSaveButton();
    songTable.clear();
    resetState();

    curPlaylist = playlist;
    curPlaylist.tracks.items = [];

    $("#playlist-title").text(playlist.name);
    $("#playlist-title").attr('href', playlist.uri);

    info("");

    fetchPlaylistTracks(playlist)
    .then(function() {
        saveState();
        enableSaveButtonWhenNeeded();
    })
    .catch(function(msg) {
        console.log('msg', msg);
        error("Error while loading playlist: " + msg);
    });
}

function findDuplicates(playlist) {
    var ids = {};
    var dups = [];
    _.each(playlist.tracks.items, function(item, i) {
        if (item.track && item.track.id) {
            var track = item.track.id;
            if (id in ids) {
                dups.push(id);
            }
            ids[id] = 1;
        }
    });
    return dups;
}

function formatDuration(dur) {
    var mins = Math.floor(dur / 60)
    var secs = Math.floor(dur - mins * 60);
    var ssecs = secs.toString();
    if (secs < 10) {
        ssecs = '0' + ssecs;
    }
    return mins + ":" + ssecs;
}

function fetchAudioFeatures(ids) {
    var cids = ids.join(',');
    var url = "https://api.spotify.com/v1/audio-features";
    return getSpotifyQ(url, { ids: cids});
}

function fetchAlbums(ids) {
    var cids = ids.join(',');
    var url = "https://api.spotify.com/v1/albums";
    return getSpotifyQ(url, { ids: cids});
}

function fetchAllAlbums(ids) {
    var maxAlbumsPerCall = 20;
    var qs = [];
    for (var i = 0; i < ids.length; i += maxAlbumsPerCall) {
        var aids = ids.slice(i, i + maxAlbumsPerCall);
        qs.push(fetchAlbums(aids));
    }
    return Q.all(qs);
}

function updateTable(tracks) {
    $("#single-playlist-contents").show();
    _.each(tracks.items, function(item, i) {
        if (item.track) {
            var track = item.track;
            addTrack(songTable, track);
        }
    });
    songTable.draw();
    $(".spinner2").hide();
}

function updateGraph(index){

  var graphs = d3.selectAll(".graphline")
           .remove()
           .exit()
           .data(dataset);

  drawGraph(index, CURVED);
}

function reOrderBell(){
  CURVED = !CURVED;
  if(CURVED) $("#curve_it").text("Linear");
  if(!CURVED) $("#curve_it").text("Curve it!");
  var firstOrder = [];
  var selectedTableOrder = songTable.order();
  if (selectedTableOrder.length >= 1) {
      firstOrder = _.clone(selectedTableOrder[0]); // object is reused by datatable!
  }
  updateGraph(firstOrder);
}

function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

function drawGraph(firstOrder, curved){
    var tmp = values[Math.max(firstOrder[0]-4,0)];

    if(firstOrder[0]  != 0){
      if(firstOrder[1] == 'asc'){
        if(!curved){
          tmp.sort(function(a, b){return a-b});
        }else{
          // var inex = tmp.indexOf((Math.max.apply(Math, tmp)-Math.min.apply(Math, tmp))/2);
          tmp.sort(function(a, b){return a-b});
          var index75 = 3*(tmp.length/4);
          var temp1 = tmp.slice(0,index75);
          var temp2 = tmp.slice(index75);
          temp1 = shuffle(temp1);
          var indexMiddlw =temp1.length/2;
          var p1 = temp1.slice(0,indexMiddlw);
          var p2 = temp1.slice(indexMiddlw);
          p1.sort(function(a, b){return a-b});
          p2.sort(function(a, b){return b-a});
          temp1 = p2.concat(p1);
          tmp = temp1.concat(temp2);
        }
      }
      if(firstOrder[1] == 'desc'){
        if(!curved){
          tmp.sort(function(a, b){return b-a});
        }else{
          tmp.sort(function(a, b){return b-a});
          var index75 = 3*(tmp.length/4);
          var temp1 = tmp.slice(0,index75);
          var temp2 = tmp.slice(index75);
          temp1 = shuffle(temp1);
          var indexMiddlw =temp1.length/2;
          var p1 = temp1.slice(0,indexMiddlw);
          var p2 = temp1.slice(indexMiddlw);
          p1.sort(function(a, b){return b-a});
          p2.sort(function(a, b){return a-b});
          temp1 = p2.concat(p1);
          tmp = temp1.concat(temp2);
        }
      }
    }


    // The number of datapoints
    var n = tmp.length;
    dataset = d3.range(n).map(function(d) {return {"y": tmp[d]}});

    // 2. Use the margin convention practice
    var margin = {top: 50, right: 150, bottom: 50, left: 50}
      , width = 600 - margin.left - margin.right // Use the window's width
      , height = 300 - margin.top - margin.bottom; // Use the window's height

    // 5. X scale will use the index of our data
    var xScale = d3.scaleLinear()
        .domain([0, n-1]) // input
        .range([0, width]); // output

    // 6. Y scale will use the randomly generate number


    var yScale = d3.scaleLinear()
        .domain([Math.min(...tmp), Math.max(...tmp)]) // input
        .range([height, 0]); // output

    // 7. d3's line generator
    var line = d3.line()
        .x(function(d, i) { return xScale(i); }) // set the x values for the line generator
        .y(function(d) { return yScale(d.y); }) // set the y values for the line generator
        .curve(d3.curveMonotoneX) // apply smoothing to the line

    // 8. An array of objects of length N. Each object has key -> value pair, the key being "y" and the value is a random number
    // console.log(d3.range(n).map(function(d) { return {"y": d3.randomUniform(1)() } }));

    // 1. Add the SVG to the page and employ #2
    var svg = d3.select(".graph").append("svg")
        .attr("class", "graphline")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    // 3. Call the x axis in a group tag
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(xScale)); // Create an axis component with d3.axisBottom

    // 4. Call the y axis in a group tag
    svg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(yScale)); // Create an axis component with d3.axisLeft

    // 9. Append the path, bind the data, and call the line generator
    svg.append("path")
        .datum(dataset) // 10. Binds data to the line
        .attr("class", "line") // Assign a class for styling
        .attr("d", line); // 11. Calls the line generator

    // 12. Appends a circle for each datapoint
    svg.selectAll(".dot")
        .data(dataset)
      .enter().append("circle") // Uses the enter().append() method
        .attr("class", "dot") // Assign a class for styling
        .attr("cx", function(d, i) { return xScale(i) })
        .attr("cy", function(d) { return yScale(d.y) })
        .attr("r", 5);

}

function updateHistogram(index) {
  var bars = d3.selectAll(".bar")
           .remove()
           .exit()
           .data(values[index]);
  drawHistogram(index);
}

function drawHistogram(index){

  var formatCount = d3.format(",.0f");

   var margin = {
      top: 50,
      right: 30,
      bottom: 50,
      left: 100
    },
    width = 600 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom;

   var x = d3.scaleLinear()
    .rangeRound([0, width]);

   var binsT = d3.histogram()
    .domain(x.domain())
    .thresholds(x.ticks(20))
    (values[index]);

   var binsN = d3.histogram()
    .domain(x.domain())
    .thresholds(5)
    (values[index]);

   var bins = binsN;

   var y = d3.scaleLinear()
    .domain([0, d3.max(bins, function(d) {
      return d.length;
    })])
    .range([height, 0]);

   d3.select(".chart").selectAll('*').remove();

   var svg = d3.select(".chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

   var bar = svg.selectAll(".bar")
    .data(bins)
    .enter().append("g")
    .attr("class", "bar")
    .attr("transform", function(d) {
      return "translate(" + x(d.x0) + "," + y(d.length) + ")";
    });

   bar.append("rect")
    .attr("x", 1)
    .attr("width", x(bins[0].x1) - x(bins[0].x0) - 1)
    .attr("height", function(d) {
      return height - y(d.length);
    });

   bar.append("text")
    .attr("dy", ".75em")
    .attr("y", 6)
    .attr("x", (x(bins[0].x1) - x(bins[0].x0)) / 2)
    .attr("text-anchor", "middle")
    .text(function(d) {
      return formatCount(d.length);
    });

   svg.append("g")
    .attr("class", "axis axis--x")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x));
}

function drawRadarChart(tracks, trackF){
    //RadarChart
  //////////////////////////////////////////////////////////////
  //////////////////////// Set-Up //////////////////////////////
  //////////////////////////////////////////////////////////////

  var acoustics = _.map(trackF, function(elm, indx) {
    // var tmp = _.pick(elm, 'acousticness','danceability','duration_ms','energy','instrumentalness','liveness', 'loudness', 'speechiness','tempo','valence');
    var tmp = _.pick(elm, 'acousticness','energy','instrumentalness','liveness', 'speechiness','valence');
    var res = [];

    Object.keys(tmp).forEach(function(key,index) {
        // key: the name of the object key
        // index: the ordinal position of the key within the object
        res.push({'axis': key, 'value': tmp[key]});
    });
    return {name: tracks.items[indx].track.name, axes: res};
   });


  var margin = { top: 30, right: 80, bottom: 50, left: 50 },
    width = Math.min(400, window.innerWidth / 4) - margin.left - margin.right,
    height = Math.min(width, window.innerHeight - margin.top - margin.bottom);

  //////////////////////////////////////////////////////////////
  ////////////////////////// Data //////////////////////////////
  //////////////////////////////////////////////////////////////
  var data = acoustics;

  //////////////////////////////////////////////////////////////
  ///// Second example /////////////////////////////////////////
  ///// Chart legend, custom color, custom unit, etc. //////////
  //////////////////////////////////////////////////////////////
  var radarChartOptions2 = {
    w: 250,
    h: 300,
    margin: margin,
    levels: 6,
    roundStrokes: false,
    format: '.0f'
  };

  // Draw the chart, get a reference the created svg element :
  let svg_radar2 = RadarChart(".radarChart2", data, radarChartOptions2);
}

function addTrack(table,track) {
    if (track && track.enInfo && 'tempo' in track.enInfo) {
        var relDate = '';
        if (track.album.id in albumDates) {
            relDate = albumDates[track.album.id];
        }
        table.row.add([
                track.which + 1,
                track.name,
                track.artists[0].name,
                relDate,
                Math.round(track.enInfo.tempo),
                Math.round(track.enInfo.energy * 100),
                Math.round(track.enInfo.danceability * 100),
                Math.round(track.enInfo.loudness),
                Math.round(track.enInfo.valence * 100),
                formatDuration(Math.round(track.enInfo.duration_ms / 1000.0)),
                Math.round(track.enInfo.acousticness * 100),
                //Math.round(track.enInfo.song_hotttnesss * 100),
                Math.round(track.popularity),
                track
        ]);
    } else {
        table.row.add([
                track.which + 1,
                track.name,
                track.artists[0].name,
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                track
        ]);
    }
}

function fetchPlaylistTracks(playlist) {

    function fetchLoop(url) {
        var tracks;

        return getSpotifyQ(url)
        .then(function(data) {
            var ids = [];
            var aids = [];

            tracks = data.tracks ? data.tracks : data;

            _.each(tracks.items, function(item, i) {
                if (item.track) {
                    item.track.which = curPlaylist.tracks.items.length;
                    curPlaylist.tracks.items.push(item);
                    if (!item.is_local) {
                        if (item.track && item.track.id) {
                            ids.push(item.track.id);
                        }
                        if (!(_.contains(aids, item.track.album.id))) {
                            if (!(item.track.album.id in albumDates)) {
                                aids.push(item.track.album.id);
                            }
                        }
                    }
                } else {
                    console.log('no track at', i);
                }
            });
            return Q.all([fetchAllAlbums(aids), fetchAudioFeatures(ids)]);
        })
        .then(function(results) {
            var allAlbums = results[0];
            var trackFeatures = results[1];

            _.each(allAlbums, function(albums) {
                _.each(albums.albums, function(album) {
                    albumDates[album.id] = album.release_date;
                });
            });
            var fmap = {};
            // beta apis are funny like this ...
            if ('audio_attributes' in trackFeatures) {
                trackFeatures = trackFeatures['audio_attributes']
            }

            if ('audio_features' in trackFeatures) {
                trackFeatures = trackFeatures['audio_features']
            }
            _.each(trackFeatures, function(trackFeature, i) {
                if (trackFeature && trackFeature.id) {
                    fmap[trackFeature.id] = trackFeature;
                }
            });

            _.each(tracks.items, function(item, i) {
                if (item.track && item.track.id) {
                    var tid = item.track.id;
                    if (tid in fmap) {
                        item.track.enInfo = fmap[tid];
                    } else {
                        item.track.enInfo = {};
                    }
                }
            });
            updateTable(tracks);

            //get popularity
            var popularity = [];
            _.each(tracks.items, function(item, i) {
                if (item.track) {
                    popularity.push(item.track.popularity);
                }
            });

            values[0] = trackFeatures.map(a => a.tempo);
            values[1] = trackFeatures.map(a => a.energy);
            values[2] = trackFeatures.map(a => a.danceability);
            values[3] = trackFeatures.map(a => a.loudness);
            values[4] = trackFeatures.map(a => a.valence);
            values[5] = trackFeatures.map(a => a.duration_ms);
            values[6] = trackFeatures.map(a => a.acousticness);
            values[7] = popularity;
            values[8] = trackFeatures.map(a => a.instrumentalness);
            values[9] = trackFeatures.map(a => a.liveness);
            values[10] = trackFeatures.map(a => a.speechiness);

            drawHistogram(0);
            drawRadarChart(tracks,trackFeatures);
            if (tracks.next) {
                return fetchLoop(tracks.next);
            }
        })

    }

    // Spotify API defect? specifying limit will actually return up to 100 items anyway.
    var startUrl = "https://api.spotify.com/v1/users/" + playlist.owner.id +
        "/playlists/" + playlist.id + "/tracks?limit=50";
    return fetchLoop(startUrl);
}

function fetchPlaylists(uid, callback) {
    // $("#playlist-list tbody").empty();
    // $(".prompt").hide();
    // $(".spinner").show();

    info("Getting your playlists");
    var url = 'https://api.spotify.com/v1/users/' + uid + '/playlists';
    var data = {
        limit:50,
        offset:0
    }
    getSpotify(url, data, callback);
}

function fetchCurrentUserProfile(callback) {
    var url = 'https://api.spotify.com/v1/me';
    getSpotify(url, null, callback);
}

function goodPlaylist(playlist) {
    return playlist.tracks.total > 0; // && playlist.owner.id == curUserID;
}

function formatOwner(owner) {
    if (owner.id == curUserID) {
        return "";
    } else {
        // opportunity to fetch owner details here
        return owner.id;
    }
}

function playlistLoaded(playlists) {
    var pl = $("#playlist-list tbody");
    $(".prompt").show();
    $(".spinner").hide();
    if (playlists) {
        info("");
        fetchSinglePlaylist(playlists.items[0]);
        _.each(playlists.items, function(playlist) {
            if (goodPlaylist(playlist)) {
                var tr = $("<tr>");

                var tdName = $("<td>")

                var aName = $("<p>")
                    .text(playlist.name)
                    .addClass('hoverable')
                    .on('click', function() {
                        fetchSinglePlaylist(playlist);
                    });
                tdName.append(aName);

                // var tdTrackCount = $("<td>").text(playlist.tracks.total);

                // var tdOwner = $("<td>").text(formatOwner(playlist.owner));

                tr.append(tdName);
                // tr.append(tdTrackCount);
                // tr.append(tdOwner);

                pl.append(tr);
            }
        });
        if (playlists.next) {
            getSpotify(playlists.next, null, playlistLoaded);
        }
    } else {
        error("Sorry, I couldn't find your playlists");
    }
}

function loadPlaylists(uid) {
    $("#playlists").show();
    fetchPlaylists(uid, playlistLoaded);
}

function inRange(val, min, max) {
    return ( ( isNaN(min) && isNaN(max) ) ||
             ( isNaN(min) && val <= max ) ||
             ( min <= val && isNaN(max) ) ||
             ( min <= val && val <= max ) );
}

function playlistFilter( settings, data, dataIndex ) {
    var minBpm = parseInt( $('#min-bpm').val(), 10 );
    var maxBpm = parseInt( $('#max-bpm').val(), 10 );
    var includeDouble = $('#include-double').is(':checked');
    var bpm = parseFloat( data[4] ) || 0;

    return inRange(bpm, minBpm, maxBpm) ||
        (includeDouble && inRange(bpm*2, minBpm, maxBpm));
}

function playTrack(track) {
    audio.attr('src', track.preview_url);
    audio.get(0).play();
}

function stopTrack() {
    audio.get(0).pause();
}


// ----------------------------------------------------------------------------
// Playlist Saving
// ----------------------------------------------------------------------------

function getSortedUrisFromTable(tracks, table) {
    // Possibly a defect in DataTables: rows() and rows().indexes() returns array in incorrect order
    // Instead, use rows().data() and calculate index from track column.
    return _.chain(table.rows({filter:'applied'}).data())
        // Web API only doesn't support local files for now.
        .select(function(rowdata) { return rowdata[12].uri.startsWith("spotify:track:"); } )
        .map (function(rowdata) {return rowdata[12].uri;})
        .value();
}

// (#save,#dropSave,#dropOverwrite).onclick
function savePlaylist(playlist, createNewPlaylist) {
    var tids = getSortedUrisFromTable(playlist.tracks.items, songTable);

    if (tids.length <= 0) {
        error("Cannot save the playlist because there are no tracks left after filtering");
        return;
    }

    disableSaveButton();
    showSaveSpinner(true);

    createOrReusePlaylist(playlist, createNewPlaylist)
    .then(function(playlistToModify) {
        return saveTidsToPlaylist(playlistToModify, tids, true);
    })
    .then(function() {
        saveState();
    })
    .catch(function(msg) {
        error(msg);
    })
    .finally(function() {
        showSaveSpinner(false);
        enableSaveButtonWhenNeeded();
    })
}

function saveTidsToPlaylist(playlist, tids, replace) {
    var sliceLength = 100;
    var this_tids = tids.slice(0, sliceLength);
    var remaining = tids.slice(sliceLength);
    var url = "https://api.spotify.com/v1/users/" + playlist.owner.id +
         "/playlists/" + playlist.id + '/tracks';
    var type;
    var json;

    if (replace) {
        type = 'PUT';
        json = { 'uris': this_tids };
    } else {
        type = 'POST';
        json = this_tids;
    }

    return callSpotifyQ(type, url, json)
    .then(function() {
        if (remaining.length > 0) {
            return saveTidsToPlaylist(playlist, remaining, false);
        }
    })
    .catch(function() {
        return Q.reject("Trouble saving tracks to the playlist");
    });
}

function createPlaylist(owner, name, isPublic) {
    var url = "https://api.spotify.com/v1/users/" + owner + "/playlists";
    var json = { name: name, 'public': isPublic };
    return callSpotifyQ('POST', url, json)
    .catch(function() {
        return Q.reject("Cannot create the new playlist");
    });
}

function createOrReusePlaylist(playlist, createNewPlaylist) {
    if (createNewPlaylist) {
        var sortName = getCurSortName();
        console.log(CURVED)
        if(CURVED){
          console.log( playlist.name + " sorted by " + sortName + " (curved)")
          return createPlaylist(curUserID, playlist.name + " sorted by " + sortName + " (curved)", playlist.public);
        }else{
          console.log( playlist.name + " sorted by " + sortName)
          return createPlaylist(curUserID, playlist.name + " sorted by " + sortName , playlist.public);
        }
    } else {
        return Q(playlist);
    }
}


// ----------------------------------------------------------------------------
// Saved playlist state tracking
// ----------------------------------------------------------------------------

function resetState() {
    songTable.order([0, 'asc']);

    $('#min-bpm').val("");
    $('#max-bpm').val("");
    $('#include-double').prop('checked', true);

    saveState();
}

// we keep track of which column we last sorted on so we
// can enable or disable the save button as appropriate
function getPlaylistState() {
    var firstOrder = [];
    var selectedTableOrder = songTable.order();
    if (selectedTableOrder.length >= 1) {
        firstOrder = _.clone(selectedTableOrder[0]); // object is reused by datatable!
    }

    updateGraph(firstOrder);

    $('#titlegraph').text("Playlist " + cols[Math.max(firstOrder[0],4)]);
    $('#descriptiongraph').text("This graphs shows how the " + cols[Math.max(firstOrder[0],4)] + " changes through the playlist. You can change it by sorting the table bellow (Click on the columns heading).");
    return {
        minBpm: parseInt( $('#min-bpm').val(), 10 ),
        maxBpm: parseInt( $('#max-bpm').val(), 10 ),
        includeDouble: $('#include-double').is(':checked'),
        order: firstOrder
    };
}

function saveState() {
    savedState = getPlaylistState();
}

function isSavable() {
    return !_.isEqual(savedState, getPlaylistState());
}

function setNeedsSave(state) {
    if (state) {
        $("#curve_it").attr('disabled', false);
        $("#save,#saveDropdown").attr('disabled', false);
        $("#save,#saveDropdown").removeClass('btn-warning');
        $("#save,#saveDropdown").addClass('btn-primary');
    } else {
        $("#curve_it").attr('disabled', true);
        $("#save,#saveDropdown").attr('disabled', true);
        $("#save,#saveDropdown").addClass('btn-warning');
        $("#save,#saveDropdown").removeClass('btn-primary');
    }
}

function updateSaveButtonState() {
    setNeedsSave(!forceDisableSave && isSavable());
}

function disableSaveButton() {
    forceDisableSave = true;
    updateSaveButtonState();
}

function enableSaveButtonWhenNeeded() {
    forceDisableSave = false;
    updateSaveButtonState();
}

function showSaveSpinner(showSpinner) {
    if (showSpinner) {
        $('#save').addClass('active');
    } else {
        $('#save').removeClass('active');
    }
}

function initTable() {
    var table = $("#song-table").DataTable( {
            paging: false,
            searching: true,  // searching must be enabled for filtering to work
            // scrollY:'300px',
            info:false,
            dom:"t", // only show table (exclude search bar)
            columnDefs: [
                { type : "time-uni", targets:9},
            ]
     });

    table.on('order.dt', function() {
        updateSaveButtonState();
    });

    $("#song-table tbody").on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
            var row = songTable.row( $(this) );
            stopTrack();
        } else {
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            var row = songTable.row( $(this) );
            var rowData = row.data();
            var track = rowData[rowData.length - 1];
            playTrack(track);
        }
    } );
    return table;
}

$(document).ready(

    function() {
        songTable = initTable();
        var args = parseArgs();

        // profile data
        var templateSource = document.getElementById('result-template').innerHTML,
        template = Handlebars.compile(templateSource),
        resultsPlaceholder = document.getElementById('result');

        if ('error' in args) {
            error("Sorry, I can't read your playlists from Spotify without authorization");
            $("#go").show();
            $("#go").on('click', function() {
                authorizeUser();
            });
        } else if ('access_token' in args) {
            accessToken = args['access_token'];
            $(".worker").hide();
            fetchCurrentUserProfile(function(user) {
                if (user) {
                    resultsPlaceholder.innerHTML = template(user);
                    curUserID = user.id;
                    $("#who").text(user.id);
                    loadPlaylists(user.id);
                    var sidebar = $('#sidebar');
                    sidebar.toggleClass('open');
                } else {
                    error("Trouble getting the user profile");
                }
            });
        } else {
            $("#sidebar").hide();
            $(".wrapper").hide();
            $("#go").show();
            $("#go").on('click', function() {
                authorizeUser();
            });
        }

        $("#save,#dropSave").on('click', function() {
            savePlaylist(curPlaylist, true);
        });
        $("#curve_it").on('click', function(){
          reOrderBell();
        })
        $("#dropOverwrite").on('click', function() {
            savePlaylist(curPlaylist, false);
        });

        $("#pick").on('click', function() {
            showPlaylists();
        });

        $.fn.dataTable.ext.search.push(playlistFilter);
        $('#min-bpm,#max-bpm,#include-double').on('keyup change', function() {
            songTable.draw();
            updateSaveButtonState();
        });

        $(".rotate").textrotator({
          animation: "dissolve", // You can pick the way it animates when rotating through words. Options are dissolve (default), fade, flip, flipUp, flipCube, flipCubeUp and spin.
          separator: ",", // If you don't want commas to be the separator, you can define a new separator (|, &, * etc.) by yourself using this field.
          speed: 2000 // How many milliseconds until the next word show.
        });

        var overlay = $('.sidebar-overlay');

       $('.sidebar-toggle').on('click', function() {
           $('.sidebar-toggle').html("Hide Playlists");
           var sidebar = $('#sidebar');
           sidebar.toggleClass('open');
           if(sidebar.hasClass('open')){
             $('.sidebar-toggle').html("Hide Playlists");
           }else{
             $('.sidebar-toggle').html("Show Playlists");
           }


           if ((sidebar.hasClass('sidebar-fixed-left') || sidebar.hasClass('sidebar-fixed-right')) && sidebar.hasClass('open')) {
                console.log("addClass")
               overlay.addClass('active');

           } else {
               console.log("removeClass")
               overlay.removeClass('active');

           }
       });

       overlay.on('click', function() {
           $(this).removeClass('active');
           $('#sidebar').removeClass('open');
       });

       var sidebar = $('#sidebar');
      var sidebarHeader = $('#sidebar .sidebar-header');
      var sidebarImg = sidebarHeader.css('background-image');
      var toggleButtons = $('.sidebar-toggle');

    // Hide toggle buttons on default position
    // toggleButtons.css('display', 'none');
    $('body').css('display', 'table');


    // Sidebar position
    $('#sidebar-position').change(function() {
        var value = $( this ).val();
        sidebar.removeClass('sidebar-fixed-left sidebar-fixed-right sidebar-stacked').addClass(value).addClass('open');
        if (value == 'sidebar-fixed-left' || value == 'sidebar-fixed-right') {
            $('.sidebar-overlay').addClass('active');
        }
        // Show toggle buttons
        if (value != '') {
            toggleButtons.css('display', 'initial');
            $('body').css('display', 'initial');
        } else {
            // Hide toggle buttons
            toggleButtons.css('display', 'none');
            $('body').css('display', 'table');
        }
    });

    // Sidebar theme
    $('#sidebar-theme').change(function() {
        var value = $( this ).val();
        sidebar.removeClass('sidebar-default sidebar-inverse sidebar-colored sidebar-colored-inverse').addClass(value)
    });

    // Header cover
    $('#sidebar-header').change(function() {
        var value = $(this).val();

        $('.sidebar-header').removeClass('header-cover').addClass(value);

        if (value == 'header-cover') {
            sidebarHeader.css('background-image', sidebarImg)
        } else {
            sidebarHeader.css('background-image', '')
        }
    });



    }
);

(function($) {
    var dropdown = $('.dropdown');

    // Add slidedown animation to dropdown
    dropdown.on('show.bs.dropdown', function(e){
        $(this).find('.dropdown-menu').first().stop(true, true).slideDown();
    });

    // Add slideup animation to dropdown
    dropdown.on('hide.bs.dropdown', function(e){
        $(this).find('.dropdown-menu').first().stop(true, true).slideUp();
    });
})(jQuery);



(function(removeClass) {

	jQuery.fn.removeClass = function( value ) {
		if ( value && typeof value.test === "function" ) {
			for ( var i = 0, l = this.length; i < l; i++ ) {
				var elem = this[i];
				if ( elem.nodeType === 1 && elem.className ) {
					var classNames = elem.className.split( /\s+/ );

					for ( var n = classNames.length; n--; ) {
						if ( value.test(classNames[n]) ) {
							classNames.splice(n, 1);
						}
					}
					elem.className = jQuery.trim( classNames.join(" ") );
				}
			}
		} else {
			removeClass.call(this, value);
		}
		return this;
	}

})(jQuery.fn.removeClass);

</script>

</body>
</html>
